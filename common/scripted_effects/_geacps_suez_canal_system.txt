#suez canal stock system effects
#scss = suez canal stock system
#########array#############
#global.scss_country_list = [TAG1,TAG2,TAG3,TAG4,TAG5,TAG6,TAG7,TAG8,TAG9,TAG10 ...] 
#global.scss_value_list = [value1,value2,value3,value4,value5,value6,value7,value8,value9,value10...]
#global.scss_ratio_list = [value1_ratio,value2_ratio,value3_ratio,value4_ratio,...]
scss_first_setting = {
	log = "scss first setup started"
	#reset variables
	#1st variable
	clear_variable = global.scss_stock_issue_total
	clear_array = global.scss_country_list
	clear_array = global.scss_value_list
	#2nd variable
	clear_variable = global.scss_total_stocks
	clear_variable = global.scss_stock_holders
	clear_array = global.scss_ratio_list
	clear_array = global.scss_ratio_list_graph
	#default value
	set_variable =  { global.scss_stock_issue_total = 200 }

	#first stockholders
	set_temp_variable = { add_country = GBR }
	set_temp_variable = { add_value = 80 }
	scss_set_stock = yes
	set_temp_variable = { add_country = FRA }
	set_temp_variable = { add_value = 80 }
	scss_set_stock = yes
	set_temp_variable = { add_country = EGY }
	set_temp_variable = { add_value = 20 }
	scss_set_stock = yes
	set_temp_variable = { add_country = ITA }
	set_temp_variable = { add_value = 20 }
	scss_set_stock = yes
	for_each_loop = {
		array = global.scss_country_list
		value = stock_value
		index = color_index
		log = "[?global.scss_country_list^color_index.GetName]:[?global.scss_value_list^color_index]"
	}
	log = "scss first setup finished"

}
scss_set_stock_2 = {#essential temp variables add_country and add_value
	if = {
		limit = {
			has_variable = add_country
			has_variable = add_value	
		}
		set_temp_variable = { temp_surplus = global.scss_stock_issue_total }
		subtract_from_temp_variable = { temp_surplus = global.scss_total_stocks }
		if = {#増加かつ余剰がない

			limit = {
				check_variable = { add_value > 0 }
				NOT = { check_variable = { temp_surplus > 0 }}		
			}
			log = "余りなんてないよ"
		}
		else = {
			if = {#増加量<=余剰
				limit = { check_variable = { add_value > temp_surplus } }
				set_temp_variable = { add_value = temp_surplus }
			}
			if = {#既にある国家
				limit = { is_in_array = { array = global.scss_country_list value = add_country } }
				custom_effect_tooltip = tt_scss_scss_change_stock
				for_each_loop = {#国家リストからif文で探し出す
					array = global.scss_country_list
					value = v_tag
					index = i_value
					if = { 
						limit = { check_variable = { v_tag = add_country } }
						log = "該当"
						add_to_variable = { global.scss_value_list^i_value = add_value }
						if = {
							limit = { NOT = {  check_variable = { global.scss_value_list^i_value > 0 } }}
							var:global.scss_country_list^i_value = {
								remove_dynamic_modifier = { modifier = scss_benefits_of_suez_canal }
								SCZ = { 
									diplomatic_relation = {
										country = PREV
										relation = military_access
										active = no
									}
								}
							}
							add_to_variable = { global.scss_stock_holders = -1 }
							remove_from_array = {
								array = global.scss_country_list
								# index = i_value
								value = v_tag
							}
							remove_from_array = {
								array = global.scss_value_list
								# index = i_value
								value = v_tag
							}

						}
					}
				}
			}
			else_if = {#新規追加
				limit = { check_variable = { add_value > 0 } }
				custom_effect_tooltip = tt_scss_scss_set_stock
				add_to_array = { global.scss_country_list = add_country }
				add_to_array = { global.scss_value_list = add_value }	
				add_to_array = { global.scss_ratio_list = 0 }	
				add_to_variable = { global.scss_stock_holders = 1 }
				add_dynamic_modifier = { modifier = scss_benefits_of_suez_canal }
				SCZ = { give_military_access = var:add_country }
				scss_calculate_stock_ratio = yes

			}
		}
		scss_calculate_stock_ratio = yes
	}
}
scss_set_stock = {
	if = {#必要な変数の確認
		limit = {
			has_variable = add_country
			has_variable = add_value
			# NOT = {
			# 	check_variable = { add_value > 0 } 
			# 	check_variable = { global.scss_stock_issue_total > global.scss_total_stocks } #発行量 > 流通量
			# }	

		}
		set_temp_variable = { temp_surplus = global.scss_stock_issue_total } 
		subtract_from_temp_variable = { temp_surplus = global.scss_total_stocks }# 発行済みの未流通量
		log = "発行済みの未流通量:[?temp_surplus]"

		if = { #新規追加？
			limit = { NOT = { is_in_array = {  array = global.scss_country_list value = add_country  } } }
			log = "新規追加"

			#新規追加処理
			add_to_array = { global.scss_country_list = add_country }
			add_to_array = { global.scss_value_list = 0 }#追加処理は後でやるので	
			add_to_array = { global.scss_ratio_list = 0 }	
			add_to_variable = { global.scss_stock_holders = 1 }
			var:add_country = {
				add_dynamic_modifier = { modifier = scss_benefits_of_suez_canal }
				give_guarantee = SCZ
			}
			SCZ = { give_military_access = var:add_country }
			scss_add_value = yes #本追加
		}
		else = {#新規追加以外（通常、数値調整が必要、削除）
			log = "新規追加以外"

			for_each_loop = {#国家リストからif文で探し出す
				array = global.scss_country_list
				value = v_tag
				index = i_value
				if = { 
					limit = { check_variable = { v_tag = add_country } }
					set_temp_variable = { temp_result = global.scss_value_list^i_value }
					add_to_temp_variable = { temp_result = add_value }#temp_resultに変更後の値をお試しで代入する
				}
			}
			log = "お試し代入:[?temp_result]"

			if = {#0以下なら削除だよね
				limit = { NOT = { check_variable = { temp_result > 0 } } }
				add_to_variable = { global.scss_stock_holders = -1 }
				for_each_scope_loop = {#国家リストからif文で探し出す
					array = global.scss_country_list
					if = { 
						limit = { check_variable = { v_tag = add_country } }
						remove_dynamic_modifier = { modifier = scss_benefits_of_suez_canal }
						SCZ = { 
							diplomatic_relation = {#軍事通行権削除
								country = PREV
								relation = military_access
								active = no
							}
						}
						diplomatic_relation = {#独立保障を削除
							country = SCZ
							relation = guarantee
							active = no
						}
						remove_from_array = {
							array = global.scss_country_list
							index = i_value
							# value = v_tag
						}
						remove_from_array = {
							array = global.scss_value_list
							index = i_value
							# value = v_tag
						}
		
					}
				}
			}
			else_if = {#発効可能量より大きかったら数値の調整必要だよね
				limit = { check_variable = { temp_surplus < add_value } }
				set_temp_variable = { add_value = temp_surplus }
				scss_add_value = yes #本追加
				log = "数値調整の後追加"

			}
			else = {
				scss_add_value = yes #本追加
				log = "通常の追加"
			}
		}
		scss_calculate_stock_ratio = yes
	}
}
scss_add_value = {#scss_set_stock用増加コード
	for_each_loop = {#国家リストからif文で探し出す
		array = global.scss_country_list
		value = v_tag
		index = i_value
		if = { 
			limit = { check_variable = { v_tag = add_country } }
			add_to_variable = { global.scss_value_list^i_value = add_value }
		}
	}


}
scss_move_stock = {#essential temp variables add_country remove_country and add_value
	if = {
		limit = {
			has_variable = add_country
			has_variable = remove_country
			has_variable = add_value
			is_in_array = { array = global.scss_country_list value = remove_country }	
		}
		custom_effect_tooltip = tt_scss_scss_move_stock 	
		log = "変数はある"
		set_temp_variable = { temp_add_country = add_country }
		set_temp_variable = { temp_remove_country = remove_country }
		set_temp_variable = { temp_add_value = add_value }
		set_temp_variable = { temp_remove_value = add_value }
		multiply_temp_variable = { temp_remove_value = -1 }
		log = "[?remove_country.GetName]から[?add_country.GetName]へ[?add_value]の送金"
		log = "[?remove_country.GetName]は[?temp_remove_value]を失う"
		log = "[?add_country.GetName]は[?temp_add_value]を得る"
		#引く
		set_temp_variable = { add_country = temp_remove_country }
		set_temp_variable = { add_value = temp_remove_value }
		scss_set_stock = yes	
		#足す
		set_temp_variable = { add_country = temp_add_country }
		set_temp_variable = { add_value = temp_add_value }
		scss_set_stock = yes	
		scss_calculate_stock_ratio = yes		
	}
}
scss_sell_all_stock = {
	custom_effect_tooltip = tt_scss_sell_all_stock
	for_each_loop = {#国家リストからif文で探し出す
		array = global.scss_country_list
		value = v_tag
		index = i_value
		if = {
			limit = { check_variable = { v_tag = remove_country } }
			var:remove_country = {
				remove_dynamic_modifier = { modifier = scss_benefits_of_suez_canal }
				SCZ = { 
					diplomatic_relation = {
						country = PREV
						relation = military_access
						active = no
					}
				}
			}
			add_to_variable = { global.scss_stock_holders = -1 }
			remove_from_array = {
				array = global.scss_country_list
				index = i_value
			}
			remove_from_array = {
				array = global.scss_value_list
				index = i_value
			}

		}
	}
	scss_calculate_stock_ratio = yes

}
scss_calculate_stock_ratio = { #
	#reset
	clear_array = global.scss_ratio_list
	#calculate total amount
	set_variable = { global.scss_total_stocks = 0 }
	for_each_loop = {
		array = global.scss_value_list
		index = i_index #
		value = v_value #
		add_to_variable = { global.scss_total_stocks = global.scss_value_list^i_index }
	}
	log = "[?global.scss_total_stocks]"
	#devide and get ratio
	for_each_loop = {
		array = global.scss_value_list
		index = i_index #
		value = v_value #
		add_to_array = { global.scss_ratio_list = v_value }
		divide_variable = { global.scss_ratio_list^i_index = global.scss_total_stocks }
		multiply_variable = { global.scss_ratio_list^i_index = 100 }
		round_variable = global.scss_ratio_list^i_index
		var:global.scss_country_list^i_index = {
			if = {
				limit = {
					NOT = {
						has_dynamic_modifier = { modifier = scss_benefits_of_suez_canal }
					}
				}
				add_dynamic_modifier = { modifier = scss_benefits_of_suez_canal }
			}
			set_variable = { scss_modifier_industrial_capacity_factory = v_value }
			multiply_variable = { scss_modifier_industrial_capacity_factory = 0.0025 }
			add_to_variable = { scss_modifier_industrial_capacity_factory = 0.0025 }
			set_variable = { scss_modifier_consumer_goods_factor = v_value }
			multiply_variable = { scss_modifier_consumer_goods_factor = -0.0025 }
			add_to_variable = { scss_modifier_consumer_goods_factor = -0.0025 }
		}
	}
	log = "before final calculate"
	scss_set_pie_chart = yes
	log = "all finish"

}
scss_set_pie_chart = {
	#reset
	log = "scss_set_pie_chart start [?global.scss_ratio_list^1]"

	clear_array = global.scss_pie_chart_array
	#create array
	for_each_loop = {
		array = global.scss_ratio_list
		value = stock_value
		index = color_index
		set_variable = { global.frame_temp = color_index }
		add_to_variable = { global.frame_temp = 1 }
		for_loop_effect = {
			start = 0
			end = stock_value
			add_to_array = { global.scss_pie_chart_array = global.frame_temp }
		}
	}
	resize_array = {
		array = global.scss_pie_chart_array
		value = global.frame_temp
		size = 100
	}

}